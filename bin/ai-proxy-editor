#!/bin/bash

# create tmux setup for AGENT on the left pane and nvim as a proxy editor on the right pane

if [ $# -ne 2 ]; then
  echo "Usage: $0 NAME AGENT" >&2
  exit 1
fi

NAME=$1
AGENT=$2

if [ -z $TMUX ]; then
  echo "Must be used within a tmux session" >&2
  exit 1
fi

n_panes=$(tmux display-message -p '#{window_panes}')
if [ $n_panes -ne 1 ]; then
  echo "Must be used on a window with a single pane" >&2
  exit 1
fi

session=$(tmux display-message -p '#S')
window_id=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 2 | head -n 1)
window="${NAME}-${window_id}"

tmux rename-window "$window"
tmux split-window -h
tmux resize-pane -t "$session:$window.1" -x "70%"

# Send commands to each pane
tmux send-keys -t "$session:$window.1" "export AI_SESSION_NAME='${window}'; $AGENT" Enter
editor_cmd="nvim -c \"let g:pxe_target_agent='$NAME'\" -c \"let g:pxe_target_pane='${session}:${window}.1'\" -S ~/.config/nvim/adhoc/proxy_editor.vim -c startinsert"
tmux send-keys -t "$session:$window.2" "$editor_cmd" Enter

# Set silence monitoring
tmux setw -t "$session:$window" monitor-silence 5
tmux setw -t "$session:$window" @ai_proxy_editor_agent "$AGENT"

tmux select-pane -t "$session:$window.2"
