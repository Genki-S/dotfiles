# vim: filetype=zsh

# magic-leader triggers useful things with leader key
# only works when LBUFFER is empty (i.e. when leader is first entered)

if [[ -n "$LBUFFER" ]]; then
  zle self-insert
  return
fi

__kubernetes_switch_context() {
  local contexts="$(kubectl config get-contexts | tail -n +2 | sed 's/^\*//' | sed 's/^\s*//' | sed 's/\s.*$//')"
  local selected="$(echo $contexts | fzy)"
  if [ -z "$selected" ]; then
    zle reset-prompt
    return
  fi
  LBUFFER="kubectl config use-context $selected"
  zle reset-prompt
  zle accept-line
}

__kubernetes_switch_namespace() {
  # TODO: show this on minibuffer
  LBUFFER="# collecting namespaces..."
  zle reset-prompt
  local namespaces="$(kubectl get namespaces | tail -n +2 | awk '{ print $1 }')"
  LBUFFER=""
  local selected="$(echo $namespaces | fzy)"
  if [ -z "$selected" ]; then
    zle reset-prompt
    return
  fi
  # LBUFFER="kubectl config set-context --current --namespace $selected"
  LBUFFER="kns $selected"
  zle reset-prompt
  zle accept-line
}

local REPLY
read-from-minibuffer -k 1 "magic-leader: "
case "${REPLY}" in
  k)
    read-from-minibuffer -k 1 "k8s ([c]ontext, [n]amespace): "
    case "${REPLY}" in
      c)
        __kubernetes_switch_context
        ;;
      n)
        __kubernetes_switch_namespace
        ;;
    esac
    ;;
  *)
    zle -M "magic-leader: no action registered for key '$REPLY'"
esac
